<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteora LB Pair PNL Tracker</title>
    <link rel="icon" type="image/svg+xml" href="./v2.svg">
    <link rel="shortcut icon" href="./v2.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script>
        // 状态变量
        let lbPairs = [];
        let filteredPairs = []; // 筛选后的交易对
        let walletData = {}; // lbPair -> [wallets]
        let pnlData = {}; // lbPair_wallet -> pnl data
        let loading = false;
        let walletDataLoading = false; // 钱包数据加载状态
        let walletDataLoaded = false; // 钱包数据是否已加载
        let expandedPairs = new Set();
        let pnlLoading = new Set();


        // 分页和筛选状态
        let currentPage = 1;
        let itemsPerPage = 10;
        let sortBy = 'fee_tvl_12h'; // liquidity, volume, fees, apr, name, bin_step, base_fee_percentage, fee_tvl_12h
        let sortOrder = 'desc'; // asc, desc
        let searchTerm = '';
        let minLiquidity = 0;
        let minVolume = 0;

        // Wallet PNL 筛选和分页状态
        let walletFilters = {}; // pairAddress -> { searchTerm, minPnl, sortBy, sortOrder, currentPage, itemsPerPage }

        // 初始化钱包筛选状态
        const initWalletFilter = (pairAddress) => {
            if (!walletFilters[pairAddress]) {
                walletFilters[pairAddress] = {
                    searchTerm: '',
                    minPnl: 0,
                    sortBy: 'total_fee_usd_claimed', // total_fee_usd_claimed, wallet
                    sortOrder: 'desc',
                    currentPage: 1,
                    itemsPerPage: 5
                };
            }
            return walletFilters[pairAddress];
        };

        // 重试机制的通用函数
        const retryRequest = async (requestFn, maxRetries = 3, delay = 1000) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await requestFn();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        };

        // 获取 LB Pairs 数据 - 一次性获取所有数据
        const fetchLbPairs = async () => {
            loading = true;
            render();
            try {
                const response = await retryRequest(async () => {
                    const res = await fetch(`https://dlmm-api.meteora.ag/pair/all_by_groups?page=0&limit=20&sort_key=feetvlratio12h&hide_low_tvl=500`);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return res.json();
                });

                console.log('📊 API Response:', response);

                if (response.groups && response.groups.length > 0) {
                    // 从 groups 中提取所有 pairs
                    lbPairs = [];
                    response.groups.forEach(group => {
                        if (group.pairs && group.pairs.length > 0) {
                            lbPairs = lbPairs.concat(group.pairs);
                        }
                    });

                    console.log('✅ Fetched LB pairs:', lbPairs.length);
                    console.log('📊 Total groups:', response.groups.length);
                    console.log('🔥 Pre-sorted by 12h Fee/TVL ratio (highest first)');
                    console.log('� Filtered: TVL ≥ $200');
                    applyFiltersAndSort(); // 应用筛选和排序
                } else {
                    console.warn('⚠️ No groups or pairs found in response');
                    lbPairs = [];

                }
            } catch (error) {
                console.error('❌ Failed to fetch LB pairs:', error);
                alert('Failed to fetch LB pairs. Please check your network connection and try again.');
            } finally {
                loading = false;
                render();
            }
        };



        // 处理 Dune 数据格式的通用函数
        const processDuneData = (data) => {
            const processedData = {};
            if (data.result && data.result.rows) {
                data.result.rows.forEach(row => {
                    let lbPair, wallets;

                    // 处理不同的数据格式
                    if (typeof row === 'string') {
                        // 最旧格式：字符串，用 '/' 分割
                        const [pair, wallet] = row.split('/');
                        lbPair = pair;
                        wallets = [wallet];
                    } else if (typeof row === 'object' && row.lbPair && row.wallet) {
                        // 旧格式：对象，单个钱包
                        lbPair = row.lbPair;
                        wallets = [row.wallet];
                    } else if (typeof row === 'object' && row.lbPair && row.wallet_array) {
                        // 新格式：对象，钱包数组
                        lbPair = row.lbPair;
                        wallets = Array.isArray(row.wallet_array) ? row.wallet_array : [row.wallet_array];
                    } else {
                        console.warn('Unknown row format:', row);
                        return;
                    }

                    if (lbPair && wallets && wallets.length > 0) {
                        if (!processedData[lbPair]) {
                            processedData[lbPair] = [];
                        }
                        // 添加所有钱包，去重
                        wallets.forEach(wallet => {
                            if (wallet && !processedData[lbPair].includes(wallet)) {
                                processedData[lbPair].push(wallet);
                            }
                        });
                    }
                });
            }
            return processedData;
        };

        // 从本地文件读取 Dune 数据
        const loadLocalDuneData = async () => {
            try {
                const response = await fetch(DATA_FILE_PATH);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Loaded data from local file:', data);

                    const processedData = processDuneData(data);

                    walletData = processedData;
                    // 只有当实际获取到钱包数据时才标记为已加载
                    const hasWalletData = Object.keys(processedData).length > 0;
                    walletDataLoaded = hasWalletData;
                    console.log('Processed wallet data:', walletData);
                    console.log('Total pairs with wallets:', Object.keys(walletData).length);
                    console.log('Has wallet data:', hasWalletData);
                    render();
                    return true; // 成功读取本地文件
                }
                return false; // 本地文件不存在或读取失败
            } catch (error) {
                console.log('Local file not found, will fetch from API:', error);
                return false;
            }
        };

        // 部署配置
        const DEVELOPMENT_MODE = true; // Enable smart data loading: Local file → API fallback
        const DATA_FILE_PATH = './dune_data.json'; // Local data file path
        const DUNE_API_KEY = 'YOUR DUNE API KEY'; // Your Dune API Key
        const DUNE_QUERY_ID = 'YOUR QUERY ID'; // Dune Query ID

        // Dune API 配置
        const options = {method: 'GET', headers: {'X-DUNE-API-KEY': DUNE_API_KEY}};

        // 下载数据文件到本地
        const downloadDuneData = (data) => {
            try {
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                // 创建下载链接
                const a = document.createElement('a');
                a.href = url;
                a.download = 'dune_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                console.log('Dune data downloaded as dune_data.json');
                alert('Data downloaded as dune_data.json. Please move this file to your project directory and refresh the page.');
            } catch (error) {
                console.error('Failed to download data file:', error);
                alert('Failed to download data file. Please check the console for errors.');
            }
        };

        // 从 Dune API 获取数据
        const fetchDuneDataFromAPI = async () => {
            try {
                console.log('🔄 Fetching data from Dune API...');
                const response = await fetch(`https://api.dune.com/api/v1/query/${DUNE_QUERY_ID}/results`, options);

                if (!response.ok) {
                    throw new Error(`Dune API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('✅ Successfully fetched data from Dune API');

                // 自动下载数据文件供下次使用
                downloadDuneData(data);

                // 处理并加载数据
                const processedData = processDuneData(data);
                walletData = processedData;

                // 只有当实际获取到钱包数据时才标记为已加载
                const hasWalletData = Object.keys(processedData).length > 0;
                walletDataLoaded = hasWalletData;

                console.log('📊 Processed wallet data from API:', walletData);
                console.log('📈 Total pairs with wallets:', Object.keys(walletData).length);
                console.log('✅ Has wallet data:', hasWalletData);

                render();
            } catch (error) {
                console.error('❌ Failed to fetch Dune data from API:', error);
                alert(`❌ Failed to fetch data from Dune API\n\nError: ${error.message}\n\nPlease check:\n1. API Key is correct\n2. Network connection\n3. Dune API quota`);
            }
        };

        // 数据获取逻辑
        const fetchDuneData = async () => {
            if (walletDataLoading) {
                console.log('Wallet data is already loading...');
                return;
            }

            if (walletDataLoaded && Object.keys(walletData).length > 0) {
                console.log('Wallet data already loaded');
                return;
            }

            walletDataLoading = true;
            render(); // 更新UI显示加载状态

            try {
                // 1. 优先尝试本地文件
                const localDataLoaded = await loadLocalDuneData();
                if (localDataLoaded) {
                    return;
                }

                // 2. 如果没有本地文件，则从 Dune API 获取
                if (DEVELOPMENT_MODE) {
                    console.log('📡 Local file not found, fetching from Dune API...');
                    await fetchDuneDataFromAPI();
                } else {
                    console.error('❌ No local dune_data.json file found and API mode disabled.');
                    alert('⚠️ Local data file dune_data.json not found\n\nPlease ensure:\n1. File is in project root directory\n2. Or enable DEVELOPMENT_MODE to fetch from API');
                }
            } finally {
                walletDataLoading = false;
                render(); // 更新UI移除加载状态
            }
        };

        // 获取钱包的 PNL 数据
        const fetchWalletPnl = async (lbPair, wallet) => {
            const key = `${lbPair}_${wallet}`;
            pnlLoading.add(key);
            render();

            try {
                const response = await retryRequest(async () => {
                    const res = await fetch(`https://dlmm-api.meteora.ag/wallet/${wallet}/${lbPair}/earning`);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return res.json();
                });

                pnlData[key] = {
                    ...response,
                    wallet,
                    lbPair
                };
            } catch (error) {
                console.error(`Failed to fetch PNL for ${wallet} on ${lbPair}:`, error);
                pnlData[key] = {
                    error: true,
                    wallet,
                    lbPair
                };
            } finally {
                pnlLoading.delete(key);
                render();
            }
        };

        // 获取所有钱包的 PNL 数据
        const fetchAllPnlForPair = async (lbPair) => {
            const wallets = walletData[lbPair] || [];
            const promises = wallets.map(wallet => fetchWalletPnl(lbPair, wallet));
            await Promise.all(promises);
        };

        // 切换展开/收起状态
        const toggleExpanded = (pairAddress) => {
            if (expandedPairs.has(pairAddress)) {
                expandedPairs.delete(pairAddress);
            } else {
                expandedPairs.add(pairAddress);
            }
            render();
        };

        // 获取筛选和排序后的钱包列表
        const getFilteredAndSortedWallets = (lbPair) => {
            const wallets = walletData[lbPair] || [];
            const filter = initWalletFilter(lbPair);

            // 筛选钱包
            let filteredWallets = wallets.filter(wallet => {
                // 搜索筛选
                if (filter.searchTerm) {
                    const searchLower = filter.searchTerm.toLowerCase();
                    if (!wallet.toLowerCase().includes(searchLower)) {
                        return false;
                    }
                }

                // PNL 筛选
                if (filter.minPnl > 0) {
                    const key = `${lbPair}_${wallet}`;
                    const pnl = pnlData[key]?.total_fee_usd_claimed || 0;
                    if (pnl < filter.minPnl) {
                        return false;
                    }
                }

                return true;
            });

            // 排序钱包
            filteredWallets.sort((a, b) => {
                const keyA = `${lbPair}_${a}`;
                const keyB = `${lbPair}_${b}`;

                let valueA, valueB;

                switch (filter.sortBy) {
                    case 'wallet':
                        valueA = a.toLowerCase();
                        valueB = b.toLowerCase();
                        break;
                    case 'total_fee_usd_claimed':
                    default:
                        valueA = pnlData[keyA]?.total_fee_usd_claimed || 0;
                        valueB = pnlData[keyB]?.total_fee_usd_claimed || 0;
                        break;
                }

                if (filter.sortOrder === 'asc') {
                    return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                } else {
                    return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                }
            });

            return filteredWallets;
        };

        // 获取当前页的钱包数据
        const getCurrentPageWallets = (lbPair) => {
            const filteredWallets = getFilteredAndSortedWallets(lbPair);
            const filter = walletFilters[lbPair];
            const startIndex = (filter.currentPage - 1) * filter.itemsPerPage;
            const endIndex = startIndex + filter.itemsPerPage;
            return filteredWallets.slice(startIndex, endIndex);
        };

        // 获取钱包总页数
        const getWalletTotalPages = (lbPair) => {
            const filteredWallets = getFilteredAndSortedWallets(lbPair);
            const filter = walletFilters[lbPair];
            return Math.ceil(filteredWallets.length / filter.itemsPerPage);
        };

        // 更新钱包筛选条件
        const updateWalletFilters = (pairAddress) => {
            const filter = walletFilters[pairAddress];

            const searchInput = document.getElementById(`walletSearch_${pairAddress}`);
            const pnlInput = document.getElementById(`minPnl_${pairAddress}`);

            if (searchInput) {
                filter.searchTerm = searchInput.value;
            }

            if (pnlInput) {
                filter.minPnl = parseFloat(pnlInput.value) || 0;
            }

            filter.currentPage = 1; // 重置到第一页
            render();
        };







        // 更新钱包排序
        const updateWalletSort = (pairAddress, newSortBy) => {
            const filter = walletFilters[pairAddress];
            if (filter.sortBy === newSortBy) {
                filter.sortOrder = filter.sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                filter.sortBy = newSortBy;
                filter.sortOrder = 'desc';
            }
            filter.currentPage = 1;
            render();
        };

        // 更改钱包页面
        const changeWalletPage = (pairAddress, page) => {
            const filter = walletFilters[pairAddress];
            const totalPages = getWalletTotalPages(pairAddress);
            if (page >= 1 && page <= totalPages) {
                filter.currentPage = page;
                render();
            }
        };

        // 更改钱包页面（只更新钱包列表）
        const changeWalletPageOnly = (pairAddress, page) => {
            const filter = walletFilters[pairAddress];
            const totalPages = getWalletTotalPages(pairAddress);
            if (page >= 1 && page <= totalPages) {
                filter.currentPage = page;
                updateWalletListOnly(pairAddress);
            }
        };

        // 更改钱包每页显示数量
        const changeWalletItemsPerPage = (pairAddress, newItemsPerPage) => {
            const filter = walletFilters[pairAddress];
            filter.itemsPerPage = newItemsPerPage;
            filter.currentPage = 1;
            render();
        };

        // 格式化数字
        const formatNumber = (num) => {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(2) + 'K';
            }
            return num?.toFixed(2) || '0';
        };

        // 格式化地址
        const formatAddress = (address) => {
            return `${address.slice(0, 4)}...${address.slice(-4)}`;
        };

        // 筛选和排序功能
        const applyFiltersAndSort = () => {
            let filtered = [...lbPairs];

            // 搜索筛选
            if (searchTerm) {
                filtered = filtered.filter(pair =>
                    pair.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    pair.address.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            // 流动性筛选
            if (minLiquidity > 0) {
                filtered = filtered.filter(pair => parseFloat(pair.liquidity) >= minLiquidity);
            }

            // 交易量筛选
            if (minVolume > 0) {
                filtered = filtered.filter(pair => pair.trade_volume_24h >= minVolume);
            }

            // 钱包数据筛选 - 只显示有钱包数据的池子
            if (walletDataLoaded && Object.keys(walletData).length > 0) {
                filtered = filtered.filter(pair => {
                    const pairWallets = walletData[pair.address] || [];
                    return pairWallets.length > 0;
                });
            }

            // 排序
            filtered.sort((a, b) => {
                let valueA, valueB;

                switch (sortBy) {
                    case 'name':
                        valueA = a.name.toLowerCase();
                        valueB = b.name.toLowerCase();
                        break;
                    case 'liquidity':
                        valueA = parseFloat(a.liquidity);
                        valueB = parseFloat(b.liquidity);
                        break;
                    case 'volume':
                        valueA = a.trade_volume_24h;
                        valueB = b.trade_volume_24h;
                        break;
                    case 'fees':
                        valueA = a.fees_24h;
                        valueB = b.fees_24h;
                        break;
                    case 'apr':
                        valueA = a.apr || 0;
                        valueB = b.apr || 0;
                        break;
                    case 'bin_step':
                        valueA = a.bin_step || 0;
                        valueB = b.bin_step || 0;
                        break;
                    case 'base_fee_percentage':
                        valueA = parseFloat(a.base_fee_percentage) || 0;
                        valueB = parseFloat(b.base_fee_percentage) || 0;
                        break;
                    case 'fee_tvl_12h':
                        valueA = (a.fee_tvl_ratio && a.fee_tvl_ratio.hour_12) || 0;
                        valueB = (b.fee_tvl_ratio && b.fee_tvl_ratio.hour_12) || 0;
                        break;
                    default:
                        valueA = parseFloat(a.liquidity);
                        valueB = parseFloat(b.liquidity);
                }

                if (sortOrder === 'asc') {
                    return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                } else {
                    return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                }
            });

            filteredPairs = filtered;
            currentPage = 1; // 重置到第一页
        };

        // 获取当前页的数据
        const getCurrentPageData = () => {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            return filteredPairs.slice(startIndex, endIndex);
        };

        // 获取总页数
        const getTotalPages = () => {
            return Math.ceil(filteredPairs.length / itemsPerPage);
        };

        // 更新筛选条件
        const updateFilters = () => {
            searchTerm = document.getElementById('searchInput').value;
            minLiquidity = parseFloat(document.getElementById('minLiquidity').value) || 0;
            minVolume = parseFloat(document.getElementById('minVolume').value) || 0;
            applyFiltersAndSort();
            render();
        };

        // 更新搜索条件（不重新渲染整个页面）
        const updateSearch = (value) => {
            searchTerm = value;
            applyFiltersAndSort();
            updateResultsOnly();
        };

        // 更新最小流动性筛选
        const updateMinLiquidity = (value) => {
            minLiquidity = parseFloat(value) || 0;
            applyFiltersAndSort();
            updateResultsOnly();
        };

        // 更新最小交易量筛选
        const updateMinVolume = (value) => {
            minVolume = parseFloat(value) || 0;
            applyFiltersAndSort();
            updateResultsOnly();
        };

        // 只更新结果区域
        const updateResultsOnly = () => {
            const currentPageData = getCurrentPageData();
            const totalPages = getTotalPages();
            const totalWallets = Object.keys(walletData).reduce((sum, key) => sum + walletData[key].length, 0);
            const totalPnlRecords = Object.keys(pnlData).length;

            // 更新统计信息
            const statsContainer = document.getElementById('stats-container');
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600">${lbPairs.length}</div>
                        <div class="text-blue-500">Total LB Pairs</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-green-600">${filteredPairs.length}</div>
                        <div class="text-green-500">Filtered Pairs</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-orange-600">${totalWallets}</div>
                        <div class="text-orange-500">Total Wallets</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600">${totalPnlRecords}</div>
                        <div class="text-purple-500">PNL Records</div>
                    </div>
                `;
            }

            // 更新池子列表
            const pairsContainer = document.getElementById('pairs-container');
            if (pairsContainer) {
                pairsContainer.innerHTML = currentPageData.map(pair => renderPair(pair)).join('');
            }

            // 更新分页信息显示
            const paginationInfo = document.querySelector('.text-sm.text-gray-600');
            if (paginationInfo) {
                paginationInfo.textContent = `Showing ${(currentPage - 1) * itemsPerPage + 1} - ${Math.min(currentPage * itemsPerPage, filteredPairs.length)} of ${filteredPairs.length} records`;
            }

            // 更新所有分页按钮
            updatePaginationButtons(totalPages);

            // 重新初始化 Lucide 图标
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        // 更新分页按钮状态
        const updatePaginationButtons = (totalPages) => {
            // 更新所有分页按钮的状态和事件
            document.querySelectorAll('[onclick*="changePage"]').forEach(button => {
                const onclickAttr = button.getAttribute('onclick');
                if (onclickAttr) {
                    // 将 changePage 替换为 changePageOnly
                    const newOnclick = onclickAttr.replace(/changePage\(/g, 'changePageOnly(');
                    button.setAttribute('onclick', newOnclick);

                    // 更新按钮状态
                    if (onclickAttr.includes('changePage(1)') || onclickAttr.includes(`changePage(${currentPage - 1})`)) {
                        button.disabled = currentPage === 1;
                    } else if (onclickAttr.includes(`changePage(${currentPage + 1})`) || onclickAttr.includes(`changePage(${totalPages})`)) {
                        button.disabled = currentPage === totalPages;
                    }
                }
            });

            // 更新页码显示
            document.querySelectorAll('.px-3.py-1.text-sm.bg-blue-500.text-white.rounded').forEach(span => {
                if (span.textContent.includes('/')) {
                    span.textContent = `${currentPage} / ${totalPages}`;
                }
            });
        };

        // 更新排序
        const updateSort = (newSortBy) => {
            if (sortBy === newSortBy) {
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                sortBy = newSortBy;
                sortOrder = 'desc';
            }
            applyFiltersAndSort();
            render();
        };

        // 更改页面
        const changePage = (page) => {
            const totalPages = getTotalPages();
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                render();
            }
        };

        // 更改页面（只更新结果区域）
        const changePageOnly = (page) => {
            const totalPages = getTotalPages();
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                updateResultsOnly();
            }
        };



        // 更改每页显示数量
        const changeItemsPerPage = (newItemsPerPage) => {
            itemsPerPage = newItemsPerPage;
            currentPage = 1;
            render();
        };

        // 渲染展开的交易对详情
        const renderExpandedPair = (pair) => {
            const pairWallets = walletData[pair.address] || [];
            const filter = initWalletFilter(pair.address);
            const filteredWallets = getFilteredAndSortedWallets(pair.address);
            const currentPageWallets = getCurrentPageWallets(pair.address);
            const totalPages = getWalletTotalPages(pair.address);

            return `
                <div class="border-t bg-gray-50 p-6">
                    <h4 class="font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="trending-up" class="w-4 h-4"></i>
                        Wallet PNL Rankings (${pairWallets.length} total, ${filteredWallets.length} filtered)
                    </h4>

                    ${pairWallets.length > 0 ? `
                        <!-- Wallet Filter Controls -->
                        <div class="bg-white rounded-lg p-4 mb-4 border">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Search Wallet</label>
                                    <input
                                        type="text"
                                        id="walletSearch_${pair.address}"
                                        placeholder="Search wallet address... (Press Enter)"
                                        value="${filter.searchTerm}"
                                        onkeypress="if(event.key === 'Enter') { updateWalletFilters('${pair.address}'); }"
                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                    >
                                </div>

                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Min PNL ($)</label>
                                    <input
                                        type="number"
                                        id="minPnl_${pair.address}"
                                        placeholder="0 (Press Enter)"
                                        value="${filter.minPnl || ''}"
                                        onkeypress="if(event.key === 'Enter') { updateWalletFilters('${pair.address}'); }"
                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                    >
                                </div>

                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Items per Page</label>
                                    <select
                                        onchange="changeWalletItemsPerPage('${pair.address}', parseInt(this.value))"
                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                    >
                                        <option value="5" ${filter.itemsPerPage === 5 ? 'selected' : ''}>5</option>
                                        <option value="10" ${filter.itemsPerPage === 10 ? 'selected' : ''}>10</option>
                                        <option value="20" ${filter.itemsPerPage === 20 ? 'selected' : ''}>20</option>
                                        <option value="50" ${filter.itemsPerPage === 50 ? 'selected' : ''}>50</option>
                                    </select>
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-2">
                                <button
                                    onclick="updateWalletSort('${pair.address}', 'total_fee_usd_claimed')"
                                    class="px-2 py-1 text-xs rounded ${filter.sortBy === 'total_fee_usd_claimed' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    PNL ${filter.sortBy === 'total_fee_usd_claimed' ? (filter.sortOrder === 'asc' ? '↑' : '↓') : ''}
                                </button>
                                <button
                                    onclick="updateWalletSort('${pair.address}', 'wallet')"
                                    class="px-2 py-1 text-xs rounded ${filter.sortBy === 'wallet' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    Address ${filter.sortBy === 'wallet' ? (filter.sortOrder === 'asc' ? '↑' : '↓') : ''}
                                </button>
                            </div>
                        </div>

                        <!-- Wallet Pagination Info -->
                        ${totalPages > 1 ? `
                            <div class="flex justify-between items-center mb-3 text-xs text-gray-600">
                                <div>
                                    Showing ${(filter.currentPage - 1) * filter.itemsPerPage + 1} - ${Math.min(filter.currentPage * filter.itemsPerPage, filteredWallets.length)} of ${filteredWallets.length} wallets
                                </div>
                                <div class="flex items-center gap-1">
                                    <button
                                        onclick="changeWalletPage('${pair.address}', ${filter.currentPage - 1})"
                                        ${filter.currentPage === 1 ? 'disabled' : ''}
                                        class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Prev
                                    </button>
                                    <span class="px-2 py-1 text-xs bg-blue-500 text-white rounded">
                                        ${filter.currentPage} / ${totalPages}
                                    </span>
                                    <button
                                        onclick="changeWalletPage('${pair.address}', ${filter.currentPage + 1})"
                                        ${filter.currentPage === totalPages ? 'disabled' : ''}
                                        class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Next
                                    </button>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Wallet List -->
                        <div id="walletList_${pair.address}" class="space-y-2">
                            ${currentPageWallets.map((wallet, index) => {
                                const globalIndex = (filter.currentPage - 1) * filter.itemsPerPage + index + 1;
                                const key = `${pair.address}_${wallet}`;
                                const pnl = pnlData[key];
                                const isLoading = pnlLoading.has(key);

                                return `
                                    <div class="flex items-center justify-between p-3 bg-white rounded border">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-sm font-semibold">
                                                #${globalIndex}
                                            </div>
                                            <div>
                                                <div class="font-mono text-sm hover:text-blue-600 cursor-pointer"
                                                     onclick="window.open('https://app.lpagent.io/portfolio?address=${wallet}', '_blank')"
                                                     title="View portfolio on LP Agent">
                                                    ${formatAddress(wallet)}
                                                    <i data-lucide="external-link" class="w-3 h-3 inline ml-1"></i>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="flex items-center gap-4">
                                            ${isLoading ? `
                                                <div class="text-gray-500 text-sm flex items-center gap-2">
                                                    <i data-lucide="refresh-cw" class="w-4 h-4 animate-spin"></i>
                                                    Loading...
                                                </div>
                                            ` : pnl?.error ? `
                                                <div class="text-red-500 text-sm">Error loading</div>
                                            ` : pnl ? `
                                                <div class="text-right">
                                                    <div class="font-semibold text-green-600">
                                                        $${pnl.total_fee_usd_claimed?.toFixed(2) || '0.00'}
                                                    </div>
                                                    <div class="text-xs text-gray-500">
                                                        X: ${(parseFloat(pnl.total_fee_x_claimed) / 1e9).toFixed(4)} |
                                                        Y: ${(parseFloat(pnl.total_fee_y_claimed) / 1e9).toFixed(4)}
                                                    </div>
                                                </div>
                                            ` : `
                                                <button
                                                    onclick="fetchWalletPnl('${pair.address}', '${wallet}')"
                                                    class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600"
                                                >
                                                    Load PNL
                                                </button>
                                            `}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div class="text-gray-500 text-center py-8">
                            <div class="mb-2">
                                ${walletDataLoaded ? 'No wallet data available for this LB pair' : 'Wallet data not loaded yet'}
                            </div>
                            ${!walletDataLoaded ? `
                                <div class="text-sm">
                                    <button
                                        onclick="fetchDuneData()"
                                        ${walletDataLoading ? 'disabled' : ''}
                                        class="px-3 py-1 ${walletDataLoading ? 'bg-yellow-500' : 'bg-blue-500 hover:bg-blue-600'} text-white rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        ${walletDataLoading ? 'Loading...' : 'Load Wallet Data'}
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `}
                </div>
            `;
        };

        // 渲染单个交易对
        const renderPair = (pair) => {
            const isExpanded = expandedPairs.has(pair.address);
            const pairWallets = walletData[pair.address] || [];

            return `
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center gap-3">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800 hover:text-blue-600 cursor-pointer"
                                        onclick="window.open('https://app.meteora.ag/dlmm/${pair.address}', '_blank')">
                                        ${pair.name}
                                        <i data-lucide="external-link" class="w-3 h-3 inline ml-1"></i>
                                    </h3>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button
                                    onclick="event.stopPropagation(); ${pairWallets.length ? `fetchAllPnlForPair('${pair.address}')` : `alert('No wallet data for this pair. Please load wallet data first.')`}"
                                    class="px-3 py-1 ${pairWallets.length ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-400 hover:bg-gray-500'} text-white rounded text-sm"
                                >
                                    Get PNL ${pairWallets.length ? `(${pairWallets.length})` : '(0)'}
                                </button>
                                <button
                                    onclick="toggleExpanded('${pair.address}')"
                                    class="p-1 hover:bg-gray-100 rounded"
                                >
                                    <i data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4 text-gray-400"></i>
                                </button>
                            </div>
                        </div>

                        <!-- 基础信息一行显示 -->
                        <div class="flex flex-wrap gap-2 mb-3 text-xs">
                            <span class="bg-blue-50 px-2 py-1 rounded">
                                <span class="text-gray-500">Liquidity:</span>
                                <span class="font-semibold text-blue-600">$${formatNumber(parseFloat(pair.liquidity))}</span>
                            </span>
                            <span class="bg-green-50 px-2 py-1 rounded">
                                <span class="text-gray-500">24h Vol:</span>
                                <span class="font-semibold text-green-600">$${formatNumber(pair.trade_volume_24h)}</span>
                            </span>
                            <span class="bg-yellow-50 px-2 py-1 rounded">
                                <span class="text-gray-500">24h Fees:</span>
                                <span class="font-semibold text-yellow-600">$${formatNumber(pair.fees_24h)}</span>
                            </span>
                            <span class="bg-purple-50 px-2 py-1 rounded">
                                <span class="text-gray-500">APR:</span>
                                <span class="font-semibold text-purple-600">${pair.apr?.toFixed(2) || '0.00'}%</span>
                            </span>
                            <span class="bg-indigo-50 px-2 py-1 rounded">
                                <span class="text-gray-500">Bin:</span>
                                <span class="font-semibold text-indigo-600">${pair.bin_step || 'N/A'}</span>
                            </span>
                            <span class="bg-pink-50 px-2 py-1 rounded">
                                <span class="text-gray-500">Base Fee:</span>
                                <span class="font-semibold text-pink-600">${pair.base_fee_percentage ? parseFloat(pair.base_fee_percentage).toFixed(3) + '%' : 'N/A'}</span>
                            </span>
                            <span class="bg-orange-50 px-2 py-1 rounded">
                                <span class="text-gray-500">12h Fee/TVL:</span>
                                <span class="font-semibold text-orange-600">${pair.fee_tvl_ratio?.hour_12 ? pair.fee_tvl_ratio.hour_12.toFixed(2) + '%' : 'N/A'}</span>
                            </span>
                        </div>
                    </div>

                    ${isExpanded ? renderExpandedPair(pair) : ''}
                </div>
            `;
        };

        // 全局焦点状态
        let globalFocusState = null;
        let focusRestoreTimeout = null;

        // 保存当前焦点状态
        const saveFocusState = () => {
            const activeElement = document.activeElement;
            if (activeElement && activeElement.tagName === 'INPUT') {
                globalFocusState = {
                    id: activeElement.id,
                    selectionStart: activeElement.selectionStart,
                    selectionEnd: activeElement.selectionEnd,
                    value: activeElement.value
                };
                return globalFocusState;
            }
            return null;
        };

        // 恢复焦点状态
        const restoreFocusState = (focusState) => {
            if (focusState && focusState.id) {
                // 清除之前的恢复计时器
                if (focusRestoreTimeout) {
                    clearTimeout(focusRestoreTimeout);
                }

                focusRestoreTimeout = setTimeout(() => {
                    const element = document.getElementById(focusState.id);
                    if (element) {
                        element.focus();
                        if (focusState.selectionStart !== undefined) {
                            element.setSelectionRange(focusState.selectionStart, focusState.selectionEnd);
                        }
                    }
                    focusRestoreTimeout = null;
                }, 10); // 稍微延长延迟时间
            }
        };

        // 主渲染函数
        const render = () => {
            // 保存当前焦点状态
            const focusState = saveFocusState();

            const app = document.getElementById('app');

            const totalWallets = Object.keys(walletData).reduce((sum, key) => sum + walletData[key].length, 0);
            const totalPnlRecords = Object.keys(pnlData).length;
            const currentPageData = getCurrentPageData();
            const totalPages = getTotalPages();

            app.innerHTML = `
                <div class="min-h-screen bg-gray-50 p-6">
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h1 class="text-3xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <i data-lucide="dollar-sign" class="text-green-500"></i>
                                Meteora LB Pair PNL Tracker
                            </h1>

                            <div class="flex gap-4 mb-6">





                            </div>

                            <div id="stats-container" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-blue-600">${lbPairs.length}</div>
                                    <div class="text-blue-500">Total LB Pairs</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600">${filteredPairs.length}</div>
                                    <div class="text-green-500">Filtered Pairs</div>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-orange-600">${totalWallets}</div>
                                    <div class="text-orange-500">Total Wallets</div>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-purple-600">${totalPnlRecords}</div>
                                    <div class="text-purple-500">PNL Records</div>
                                </div>
                            </div>
                        </div>



                        <!-- 网站功能描述 -->
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg shadow-lg p-6 mb-6 border border-blue-100">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0">
                                    <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center">
                                        <i data-lucide="trending-up" class="w-6 h-6 text-white"></i>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <h2 class="text-xl font-bold text-gray-800 mb-2">Meteora LB Pair PNL Tracker</h2>
                                    <p class="text-gray-600 mb-4">
                                        Professional Meteora liquidity mining analysis tool that transparently displays real P&L data and participant information for each pool, helping LP traders of all levels develop better strategies.
                                    </p>

                                    <div class="space-y-3">
                                        <!-- Beginner LP -->
                                        <div class="bg-white rounded-lg p-4 border border-green-100">
                                            <div class="flex items-center gap-2 mb-2">
                                                <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                                                    <i data-lucide="graduation-cap" class="w-3 h-3 text-white"></i>
                                                </div>
                                                <span class="font-semibold text-green-700">Beginner LP Traders</span>
                                            </div>
                                            <p class="text-sm text-gray-600">Get intuitive insights into which pools are profitable, who's making money, and how much they're earning to build foundational LP knowledge</p>
                                        </div>

                                        <!-- Intermediate LP -->
                                        <div class="bg-white rounded-lg p-4 border border-blue-100">
                                            <div class="flex items-center gap-2 mb-2">
                                                <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
                                                    <i data-lucide="target" class="w-3 h-3 text-white"></i>
                                                </div>
                                                <span class="font-semibold text-blue-700">Intermediate LP Traders</span>
                                            </div>
                                            <p class="text-sm text-gray-600">Discover smart addresses with similar trading habits and risk tolerance to copy successful strategies and learn from proven approaches</p>
                                        </div>

                                        <!-- Advanced LP -->
                                        <div class="bg-white rounded-lg p-4 border border-purple-100">
                                            <div class="flex items-center gap-2 mb-2">
                                                <div class="w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center">
                                                    <i data-lucide="brain" class="w-3 h-3 text-white"></i>
                                                </div>
                                                <span class="font-semibold text-purple-700">Advanced LP Traders</span>
                                            </div>
                                            <p class="text-sm text-gray-600">Analyze sophisticated strategies in depth, extract core logic patterns, and integrate insights into your own trading systems</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filter and Sort Controls -->
                        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i data-lucide="filter" class="w-5 h-5"></i>
                                Filter and Sort
                            </h2>

                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                                    <input
                                        type="text"
                                        id="searchInput"
                                        placeholder="Search pair name or address... (Press Enter)"
                                        value="${searchTerm}"
                                        onkeydown="if(event.key === 'Enter') updateSearch(this.value)"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Min Liquidity ($)</label>
                                    <input
                                        type="number"
                                        id="minLiquidity"
                                        placeholder="0 (Press Enter)"
                                        value="${minLiquidity || ''}"
                                        onkeydown="if(event.key === 'Enter') updateMinLiquidity(this.value)"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Min 24h Volume ($)</label>
                                    <input
                                        type="number"
                                        id="minVolume"
                                        placeholder="0 (Press Enter)"
                                        value="${minVolume || ''}"
                                        onkeydown="if(event.key === 'Enter') updateMinVolume(this.value)"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Items per Page</label>
                                    <select
                                        onchange="changeItemsPerPage(parseInt(this.value))"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>10</option>
                                        <option value="25" ${itemsPerPage === 25 ? 'selected' : ''}>25</option>
                                        <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50</option>
                                        <option value="100" ${itemsPerPage === 100 ? 'selected' : ''}>100</option>
                                    </select>
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-2">

                                <button
                                    onclick="updateSort('liquidity')"
                                    class="px-3 py-1 text-sm rounded-md ${sortBy === 'liquidity' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    Liquidity ${sortBy === 'liquidity' ? (sortOrder === 'asc' ? '↑' : '↓') : ''}
                                </button>
                                <button
                                    onclick="updateSort('volume')"
                                    class="px-3 py-1 text-sm rounded-md ${sortBy === 'volume' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    24h Volume ${sortBy === 'volume' ? (sortOrder === 'asc' ? '↑' : '↓') : ''}
                                </button>
                                <button
                                    onclick="updateSort('fees')"
                                    class="px-3 py-1 text-sm rounded-md ${sortBy === 'fees' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    24h Fees ${sortBy === 'fees' ? (sortOrder === 'asc' ? '↑' : '↓') : ''}
                                </button>
                                <button
                                    onclick="updateSort('apr')"
                                    class="px-3 py-1 text-sm rounded-md ${sortBy === 'apr' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    APR ${sortBy === 'apr' ? (sortOrder === 'asc' ? '↑' : '↓') : ''}
                                </button>
                                <button
                                    onclick="updateSort('bin_step')"
                                    class="px-3 py-1 text-sm rounded-md ${sortBy === 'bin_step' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    Bin Step ${sortBy === 'bin_step' ? (sortOrder === 'asc' ? '↑' : '↓') : ''}
                                </button>
                                <button
                                    onclick="updateSort('base_fee_percentage')"
                                    class="px-3 py-1 text-sm rounded-md ${sortBy === 'base_fee_percentage' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    Base Fee ${sortBy === 'base_fee_percentage' ? (sortOrder === 'asc' ? '↑' : '↓') : ''}
                                </button>
                                <button
                                    onclick="updateSort('fee_tvl_12h')"
                                    class="px-3 py-1 text-sm rounded-md ${sortBy === 'fee_tvl_12h' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    12h Fee/TVL ${sortBy === 'fee_tvl_12h' ? (sortOrder === 'asc' ? '↑' : '↓') : ''}
                                </button>
                            </div>
                        </div>

                        ${loading ? `
                            <div class="flex justify-center items-center py-12">
                                <i data-lucide="refresh-cw" class="w-8 h-8 animate-spin text-blue-500"></i>
                                <span class="ml-2 text-gray-600">Loading LB Pairs...</span>
                            </div>
                        ` : `
                            <!-- Pagination Info -->
                            <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
                                <div class="flex justify-between items-center">
                                    <div class="text-sm text-gray-600">
                                        Showing ${(currentPage - 1) * itemsPerPage + 1} - ${Math.min(currentPage * itemsPerPage, filteredPairs.length)} of ${filteredPairs.length} records
                                    </div>

                                    <div class="flex items-center gap-2">
                                        <button
                                            onclick="changePage(1)"
                                            ${currentPage === 1 ? 'disabled' : ''}
                                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            First
                                        </button>
                                        <button
                                            onclick="changePage(${currentPage - 1})"
                                            ${currentPage === 1 ? 'disabled' : ''}
                                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            Previous
                                        </button>

                                        <span class="px-3 py-1 text-sm bg-blue-500 text-white rounded">
                                            ${currentPage} / ${totalPages}
                                        </span>

                                        <button
                                            onclick="changePage(${currentPage + 1})"
                                            ${currentPage === totalPages ? 'disabled' : ''}
                                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            Next
                                        </button>
                                        <button
                                            onclick="changePage(${totalPages})"
                                            ${currentPage === totalPages ? 'disabled' : ''}
                                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            Last
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- 交易对列表 -->
                            <div id="pairs-container" class="space-y-4">
                                ${currentPageData.map(pair => renderPair(pair)).join('')}
                            </div>

                            <!-- 底部分页 -->
                            ${totalPages > 1 ? `
                                <div class="bg-white rounded-lg shadow-lg p-4 mt-6">
                                    <div class="flex justify-center items-center gap-2">
                                        <button
                                            onclick="changePageOnly(1)"
                                            ${currentPage === 1 ? 'disabled' : ''}
                                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            First
                                        </button>
                                        <button
                                            onclick="changePageOnly(${currentPage - 1})"
                                            ${currentPage === 1 ? 'disabled' : ''}
                                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            Previous
                                        </button>

                                        ${Array.from({length: Math.min(5, totalPages)}, (_, i) => {
                                            let pageNum;
                                            if (totalPages <= 5) {
                                                pageNum = i + 1;
                                            } else if (currentPage <= 3) {
                                                pageNum = i + 1;
                                            } else if (currentPage >= totalPages - 2) {
                                                pageNum = totalPages - 4 + i;
                                            } else {
                                                pageNum = currentPage - 2 + i;
                                            }

                                            return `
                                                <button
                                                    onclick="changePageOnly(${pageNum})"
                                                    class="px-3 py-1 text-sm rounded ${pageNum === currentPage ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                                                >
                                                    ${pageNum}
                                                </button>
                                            `;
                                        }).join('')}

                                        <button
                                            onclick="changePageOnly(${currentPage + 1})"
                                            ${currentPage === totalPages ? 'disabled' : ''}
                                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            Next
                                        </button>
                                        <button
                                            onclick="changePageOnly(${totalPages})"
                                            ${currentPage === totalPages ? 'disabled' : ''}
                                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            Last
                                        </button>
                                    </div>
                                </div>
                            ` : ''}

                            <!-- 底部三卡片布局 -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
                                <!-- Buy Me Coffee 卡片 -->
                                <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                                    <div class="flex flex-col items-center gap-4">
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="coffee" class="w-6 h-6 text-amber-600"></i>
                                            <h3 class="text-lg font-semibold text-gray-800">Support</h3>
                                        </div>
                                        <p class="text-gray-600 text-sm">
                                            If this tool has been helpful for your DeFi journey, consider supporting its development.
                                        </p>
                                        <a
                                            href="https://tiplink.io/blinks/donate?dest=G4FEgdE3yduy8WexqLWda3SGYBTgnydP37GnCcZRJjPR"
                                            target="_blank"
                                            class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-medium rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl"
                                        >
                                            <i data-lucide="coffee" class="w-4 h-4"></i>
                                            Buy me a coffee ☕
                                        </a>
                                        <p class="text-xs text-gray-500">
                                            Powered by TipLink
                                        </p>
                                    </div>
                                </div>

                                <!-- Disclaimer 卡片 -->
                                <div class="bg-white rounded-lg shadow-lg p-6">
                                    <div class="flex items-center gap-2 mb-4">
                                        <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-500"></i>
                                        <h3 class="text-lg font-semibold text-gray-800">Disclaimer</h3>
                                    </div>
                                    <div class="text-sm text-gray-600 space-y-2">
                                        <p>This tool is for informational purposes only and does not constitute financial advice.</p>
                                        <p>Cryptocurrency and DeFi investments carry significant risks, including potential loss of principal.</p>
                                        <p>Always conduct your own research and consult qualified financial advisors.</p>
                                    </div>
                                </div>

                                <!-- Contact & Links 卡片 -->
                                <div class="bg-white rounded-lg shadow-lg p-6">
                                    <div class="flex items-center gap-2 mb-4">
                                        <i data-lucide="users" class="w-6 h-6 text-blue-500"></i>
                                        <h3 class="text-lg font-semibold text-gray-800">Connect</h3>
                                    </div>
                                    <div class="space-y-3">
                                        <a href="https://x.com/rochestor_mu" target="_blank"
                                           class="flex items-center gap-2 text-blue-600 hover:text-blue-800 transition-colors">
                                            <i data-lucide="twitter" class="w-4 h-4"></i>
                                            <span class="text-sm">Follow on X (Twitter)</span>
                                        </a>
                                        <a href="https://github.com/gududefengzhong" target="_blank"
                                           class="flex items-center gap-2 text-gray-700 hover:text-gray-900 transition-colors">
                                            <i data-lucide="github" class="w-4 h-4"></i>
                                            <span class="text-sm">View on GitHub</span>
                                        </a>
                                        <a href="https://app.lpagent.io/?referral=GE6Csiu" target="_blank"
                                           class="flex items-center gap-2 text-green-600 hover:text-green-800 transition-colors">
                                            <i data-lucide="trending-up" class="w-4 h-4"></i>
                                            <span class="text-sm">Try LP Agent</span>
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- 页脚版权信息 -->
                            <div class="text-center py-8 mt-8 border-t border-gray-200">
                                <div class="text-sm text-gray-500">
                                    <div>Built with ❤️ for the LP Army</div>
                                    <div class="mt-1">© 2025 Meteora LB Pair Tracker</div>
                                </div>
                            </div>

                        `}
                    </div>
                </div>
            `;

            // 重新初始化 Lucide 图标
            lucide.createIcons();

            // 恢复焦点状态
            restoreFocusState(focusState);
        };

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化筛选数据
            filteredPairs = [...lbPairs];
            render();
            fetchLbPairs();
            fetchDuneData();
        });
    </script>
</body>
</html>
