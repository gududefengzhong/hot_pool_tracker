<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteora LB Pair PNL Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script>
        // Áä∂ÊÄÅÂèòÈáè
        let lbPairs = [];
        let filteredPairs = []; // Á≠õÈÄâÂêéÁöÑ‰∫§ÊòìÂØπ
        let walletData = {}; // lbPair -> [wallets]
        let pnlData = {}; // lbPair_wallet -> pnl data
        let loading = false;
        let walletDataLoading = false; // Èí±ÂåÖÊï∞ÊçÆÂä†ËΩΩÁä∂ÊÄÅ
        let walletDataLoaded = false; // Èí±ÂåÖÊï∞ÊçÆÊòØÂê¶Â∑≤Âä†ËΩΩ
        let expandedPairs = new Set();
        let pnlLoading = new Set();

        // ÂàÜÈ°µÂíåÁ≠õÈÄâÁä∂ÊÄÅ
        let currentPage = 1;
        let itemsPerPage = 10;
        let sortBy = 'fee_tvl_30min'; // liquidity, volume, fees, apr, name, bin_step, base_fee_percentage, fee_tvl_30min
        let sortOrder = 'desc'; // asc, desc
        let searchTerm = '';
        let minLiquidity = 0;
        let minVolume = 0;

        // Wallet PNL Á≠õÈÄâÂíåÂàÜÈ°µÁä∂ÊÄÅ
        let walletFilters = {}; // pairAddress -> { searchTerm, minPnl, sortBy, sortOrder, currentPage, itemsPerPage }

        // ÂàùÂßãÂåñÈí±ÂåÖÁ≠õÈÄâÁä∂ÊÄÅ
        const initWalletFilter = (pairAddress) => {
            if (!walletFilters[pairAddress]) {
                walletFilters[pairAddress] = {
                    searchTerm: '',
                    minPnl: 0,
                    sortBy: 'total_fee_usd_claimed', // total_fee_usd_claimed, wallet
                    sortOrder: 'desc',
                    currentPage: 1,
                    itemsPerPage: 5
                };
            }
            return walletFilters[pairAddress];
        };

        // ÈáçËØïÊú∫Âà∂ÁöÑÈÄöÁî®ÂáΩÊï∞
        const retryRequest = async (requestFn, maxRetries = 3, delay = 1000) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await requestFn();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        };

        // Ëé∑Âèñ LB Pairs Êï∞ÊçÆ - ‰∏ÄÊ¨°ÊÄßËé∑ÂèñÊâÄÊúâÊï∞ÊçÆ
        const fetchLbPairs = async () => {
            loading = true;
            render();
            try {
                const response = await retryRequest(async () => {
                    const res = await fetch(`https://dlmm-api.meteora.ag/pair/all_by_groups?page=0&limit=20&sort_key=feetvlratio30m&hide_low_tvl=200`);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return res.json();
                });

                console.log('üìä API Response:', response);

                if (response.groups && response.groups.length > 0) {
                    // ‰ªé groups ‰∏≠ÊèêÂèñÊâÄÊúâ pairs
                    lbPairs = [];
                    response.groups.forEach(group => {
                        if (group.pairs && group.pairs.length > 0) {
                            lbPairs = lbPairs.concat(group.pairs);
                        }
                    });

                    console.log('‚úÖ Fetched LB pairs:', lbPairs.length);
                    console.log('üìä Total groups:', response.groups.length);
                    console.log('ÔøΩ Pre-sorted by 30min Fee/TVL ratio (highest first)');
                    console.log('ÔøΩ Filtered: TVL ‚â• $200');
                    applyFiltersAndSort(); // Â∫îÁî®Á≠õÈÄâÂíåÊéíÂ∫è
                } else {
                    console.warn('‚ö†Ô∏è No groups or pairs found in response');
                    lbPairs = [];

                }
            } catch (error) {
                console.error('‚ùå Failed to fetch LB pairs:', error);
                alert('Failed to fetch LB pairs. Please check your network connection and try again.');
            } finally {
                loading = false;
                render();
            }
        };



        // Â§ÑÁêÜ Dune Êï∞ÊçÆÊ†ºÂºèÁöÑÈÄöÁî®ÂáΩÊï∞
        const processDuneData = (data) => {
            const processedData = {};
            if (data.result && data.result.rows) {
                data.result.rows.forEach(row => {
                    let lbPair, wallet;

                    // Â§ÑÁêÜ‰∏çÂêåÁöÑÊï∞ÊçÆÊ†ºÂºè
                    if (typeof row === 'string') {
                        // ÊóßÊ†ºÂºèÔºöÂ≠óÁ¨¶‰∏≤ÔºåÁî® '/' ÂàÜÂâ≤
                        [lbPair, wallet] = row.split('/');
                    } else if (typeof row === 'object' && row.lbPair && row.wallet) {
                        // Êñ∞Ê†ºÂºèÔºöÂØπË±°ÔºåÁõ¥Êé•ÂèñÂ±ûÊÄß
                        lbPair = row.lbPair;
                        wallet = row.wallet;
                    } else {
                        console.warn('Unknown row format:', row);
                        return;
                    }

                    if (lbPair && wallet) {
                        if (!processedData[lbPair]) {
                            processedData[lbPair] = [];
                        }
                        processedData[lbPair].push(wallet);
                    }
                });
            }
            return processedData;
        };

        // ‰ªéÊú¨Âú∞Êñá‰ª∂ËØªÂèñ Dune Êï∞ÊçÆ
        const loadLocalDuneData = async () => {
            try {
                const response = await fetch(DATA_FILE_PATH);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Loaded data from local file:', data);

                    const processedData = processDuneData(data);

                    walletData = processedData;
                    // Âè™ÊúâÂΩìÂÆûÈôÖËé∑ÂèñÂà∞Èí±ÂåÖÊï∞ÊçÆÊó∂ÊâçÊ†áËÆ∞‰∏∫Â∑≤Âä†ËΩΩ
                    const hasWalletData = Object.keys(processedData).length > 0;
                    walletDataLoaded = hasWalletData;
                    console.log('Processed wallet data:', walletData);
                    console.log('Total pairs with wallets:', Object.keys(walletData).length);
                    console.log('Has wallet data:', hasWalletData);
                    render();
                    return true; // ÊàêÂäüËØªÂèñÊú¨Âú∞Êñá‰ª∂
                }
                return false; // Êú¨Âú∞Êñá‰ª∂‰∏çÂ≠òÂú®ÊàñËØªÂèñÂ§±Ë¥•
            } catch (error) {
                console.log('Local file not found, will fetch from API:', error);
                return false;
            }
        };

        // ÈÉ®ÁΩ≤ÈÖçÁΩÆ
        const DEVELOPMENT_MODE = true; // ÂêØÁî®Êô∫ËÉΩÊï∞ÊçÆÂä†ËΩΩÔºöÊú¨Âú∞Êñá‰ª∂ ‚Üí API Ëé∑Âèñ
        const DATA_FILE_PATH = './dune_data.json'; // Êú¨Âú∞Êï∞ÊçÆÊñá‰ª∂Ë∑ØÂæÑ
        const DUNE_API_KEY = 'your api key'; // ‰Ω†ÁöÑ Dune API Key
        const DUNE_QUERY_ID = 'your query id'; // Dune Êü•ËØ¢ ID

        // Dune API ÈÖçÁΩÆ
        const options = {method: 'GET', headers: {'X-DUNE-API-KEY': DUNE_API_KEY}};

        // ‰∏ãËΩΩÊï∞ÊçÆÊñá‰ª∂Âà∞Êú¨Âú∞
        const downloadDuneData = (data) => {
            try {
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                const a = document.createElement('a');
                a.href = url;
                a.download = 'dune_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                console.log('Dune data downloaded as dune_data.json');
                alert('Data downloaded as dune_data.json. Please move this file to your project directory and refresh the page.');
            } catch (error) {
                console.error('Failed to download data file:', error);
                alert('Failed to download data file. Please check the console for errors.');
            }
        };

        // ‰ªé Dune API Ëé∑ÂèñÊï∞ÊçÆ
        const fetchDuneDataFromAPI = async () => {
            try {
                console.log('üîÑ Fetching data from Dune API...');
                const response = await fetch(`https://api.dune.com/api/v1/query/${DUNE_QUERY_ID}/results`, options);

                if (!response.ok) {
                    throw new Error(`Dune API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('‚úÖ Successfully fetched data from Dune API');

                // Ëá™Âä®‰∏ãËΩΩÊï∞ÊçÆÊñá‰ª∂‰æõ‰∏ãÊ¨°‰ΩøÁî®
                downloadDuneData(data);

                // Â§ÑÁêÜÂπ∂Âä†ËΩΩÊï∞ÊçÆ
                const processedData = processDuneData(data);
                walletData = processedData;

                // Âè™ÊúâÂΩìÂÆûÈôÖËé∑ÂèñÂà∞Èí±ÂåÖÊï∞ÊçÆÊó∂ÊâçÊ†áËÆ∞‰∏∫Â∑≤Âä†ËΩΩ
                const hasWalletData = Object.keys(processedData).length > 0;
                walletDataLoaded = hasWalletData;

                console.log('üìä Processed wallet data from API:', walletData);
                console.log('üìà Total pairs with wallets:', Object.keys(walletData).length);
                console.log('‚úÖ Has wallet data:', hasWalletData);

                render();
            } catch (error) {
                console.error('‚ùå Failed to fetch Dune data from API:', error);
                alert(`‚ùå ‰ªé Dune API Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•\n\nÈîôËØØ‰ø°ÊÅØÔºö${error.message}\n\nËØ∑Ê£ÄÊü•Ôºö\n1. API Key ÊòØÂê¶Ê≠£Á°Æ\n2. ÁΩëÁªúËøûÊé•ÊòØÂê¶Ê≠£Â∏∏\n3. Dune API ÈÖçÈ¢ùÊòØÂê¶ÂÖÖË∂≥`);
            }
        };

        // Êï∞ÊçÆËé∑ÂèñÈÄªËæë
        const fetchDuneData = async () => {
            if (walletDataLoading) {
                console.log('Wallet data is already loading...');
                return;
            }

            if (walletDataLoaded && Object.keys(walletData).length > 0) {
                console.log('Wallet data already loaded');
                return;
            }

            walletDataLoading = true;
            render(); // Êõ¥Êñ∞UIÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ

            try {
                // 1. ‰ºòÂÖàÂ∞ùËØïÊú¨Âú∞Êñá‰ª∂
                const localDataLoaded = await loadLocalDuneData();
                if (localDataLoaded) {
                    return;
                }

                // 2. Â¶ÇÊûúÊ≤°ÊúâÊú¨Âú∞Êñá‰ª∂ÔºåÂàô‰ªé Dune API Ëé∑Âèñ
                if (DEVELOPMENT_MODE) {
                    console.log('üì° Local file not found, fetching from Dune API...');
                    await fetchDuneDataFromAPI();
                } else {
                    console.error('‚ùå No local dune_data.json file found and API mode disabled.');
                    alert('‚ö†Ô∏è Êú™ÊâæÂà∞Êú¨Âú∞Êï∞ÊçÆÊñá‰ª∂ dune_data.json\n\nËØ∑Á°Æ‰øùÔºö\n1. Êñá‰ª∂Âú®È°πÁõÆÊ†πÁõÆÂΩï\n2. ÊàñËÄÖÂêØÁî® DEVELOPMENT_MODE ‰ªé API Ëé∑ÂèñÊï∞ÊçÆ');
                }
            } finally {
                walletDataLoading = false;
                render(); // Êõ¥Êñ∞UIÁßªÈô§Âä†ËΩΩÁä∂ÊÄÅ
            }
        };

        // Ëé∑ÂèñÈí±ÂåÖÁöÑ PNL Êï∞ÊçÆ
        const fetchWalletPnl = async (lbPair, wallet) => {
            const key = `${lbPair}_${wallet}`;
            pnlLoading.add(key);
            render();
            
            try {
                const response = await retryRequest(async () => {
                    const res = await fetch(`https://dlmm-api.meteora.ag/wallet/${wallet}/${lbPair}/earning`);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return res.json();
                });
                
                pnlData[key] = {
                    ...response,
                    wallet,
                    lbPair
                };
            } catch (error) {
                console.error(`Failed to fetch PNL for ${wallet} on ${lbPair}:`, error);
                pnlData[key] = {
                    error: true,
                    wallet,
                    lbPair
                };
            } finally {
                pnlLoading.delete(key);
                render();
            }
        };

        // Ëé∑ÂèñÊâÄÊúâÈí±ÂåÖÁöÑ PNL Êï∞ÊçÆ
        const fetchAllPnlForPair = async (lbPair) => {
            const wallets = walletData[lbPair] || [];
            const promises = wallets.map(wallet => fetchWalletPnl(lbPair, wallet));
            await Promise.all(promises);
        };

        // ÂàáÊç¢Â±ïÂºÄ/Êî∂Ëµ∑Áä∂ÊÄÅ
        const toggleExpanded = (pairAddress) => {
            if (expandedPairs.has(pairAddress)) {
                expandedPairs.delete(pairAddress);
            } else {
                expandedPairs.add(pairAddress);
            }
            render();
        };

        // Ëé∑ÂèñÁ≠õÈÄâÂíåÊéíÂ∫èÂêéÁöÑÈí±ÂåÖÂàóË°®
        const getFilteredAndSortedWallets = (lbPair) => {
            const wallets = walletData[lbPair] || [];
            const filter = initWalletFilter(lbPair);

            // Á≠õÈÄâÈí±ÂåÖ
            let filteredWallets = wallets.filter(wallet => {
                // ÊêúÁ¥¢Á≠õÈÄâ
                if (filter.searchTerm) {
                    const searchLower = filter.searchTerm.toLowerCase();
                    if (!wallet.toLowerCase().includes(searchLower)) {
                        return false;
                    }
                }

                // PNL Á≠õÈÄâ
                if (filter.minPnl > 0) {
                    const key = `${lbPair}_${wallet}`;
                    const pnl = pnlData[key]?.total_fee_usd_claimed || 0;
                    if (pnl < filter.minPnl) {
                        return false;
                    }
                }

                return true;
            });

            // ÊéíÂ∫èÈí±ÂåÖ
            filteredWallets.sort((a, b) => {
                const keyA = `${lbPair}_${a}`;
                const keyB = `${lbPair}_${b}`;

                let valueA, valueB;

                switch (filter.sortBy) {
                    case 'wallet':
                        valueA = a.toLowerCase();
                        valueB = b.toLowerCase();
                        break;
                    case 'total_fee_usd_claimed':
                    default:
                        valueA = pnlData[keyA]?.total_fee_usd_claimed || 0;
                        valueB = pnlData[keyB]?.total_fee_usd_claimed || 0;
                        break;
                }

                if (filter.sortOrder === 'asc') {
                    return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                } else {
                    return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                }
            });

            return filteredWallets;
        };

        // Ëé∑ÂèñÂΩìÂâçÈ°µÁöÑÈí±ÂåÖÊï∞ÊçÆ
        const getCurrentPageWallets = (lbPair) => {
            const filteredWallets = getFilteredAndSortedWallets(lbPair);
            const filter = walletFilters[lbPair];
            const startIndex = (filter.currentPage - 1) * filter.itemsPerPage;
            const endIndex = startIndex + filter.itemsPerPage;
            return filteredWallets.slice(startIndex, endIndex);
        };

        // Ëé∑ÂèñÈí±ÂåÖÊÄªÈ°µÊï∞
        const getWalletTotalPages = (lbPair) => {
            const filteredWallets = getFilteredAndSortedWallets(lbPair);
            const filter = walletFilters[lbPair];
            return Math.ceil(filteredWallets.length / filter.itemsPerPage);
        };

        // Êõ¥Êñ∞Èí±ÂåÖÁ≠õÈÄâÊù°‰ª∂
        const updateWalletFilters = (pairAddress) => {
            const filter = walletFilters[pairAddress];
            filter.searchTerm = document.getElementById(`walletSearch_${pairAddress}`).value;
            filter.minPnl = parseFloat(document.getElementById(`minPnl_${pairAddress}`).value) || 0;
            filter.currentPage = 1; // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
            render();
        };

        // Êõ¥Êñ∞Èí±ÂåÖÊéíÂ∫è
        const updateWalletSort = (pairAddress, newSortBy) => {
            const filter = walletFilters[pairAddress];
            if (filter.sortBy === newSortBy) {
                filter.sortOrder = filter.sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                filter.sortBy = newSortBy;
                filter.sortOrder = 'desc';
            }
            filter.currentPage = 1;
            render();
        };

        // Êõ¥ÊîπÈí±ÂåÖÈ°µÈù¢
        const changeWalletPage = (pairAddress, page) => {
            const filter = walletFilters[pairAddress];
            const totalPages = getWalletTotalPages(pairAddress);
            if (page >= 1 && page <= totalPages) {
                filter.currentPage = page;
                render();
            }
        };

        // Êõ¥ÊîπÈí±ÂåÖÊØèÈ°µÊòæÁ§∫Êï∞Èáè
        const changeWalletItemsPerPage = (pairAddress, newItemsPerPage) => {
            const filter = walletFilters[pairAddress];
            filter.itemsPerPage = newItemsPerPage;
            filter.currentPage = 1;
            render();
        };

        // Ê†ºÂºèÂåñÊï∞Â≠ó
        const formatNumber = (num) => {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(2) + 'K';
            }
            return num?.toFixed(2) || '0';
        };

        // Ê†ºÂºèÂåñÂú∞ÂùÄ
        const formatAddress = (address) => {
            return `${address.slice(0, 4)}...${address.slice(-4)}`;
        };

        // Á≠õÈÄâÂíåÊéíÂ∫èÂäüËÉΩ
        const applyFiltersAndSort = () => {
            let filtered = [...lbPairs];

            // ÊêúÁ¥¢Á≠õÈÄâ
            if (searchTerm) {
                filtered = filtered.filter(pair =>
                    pair.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    pair.address.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            // ÊµÅÂä®ÊÄßÁ≠õÈÄâ
            if (minLiquidity > 0) {
                filtered = filtered.filter(pair => parseFloat(pair.liquidity) >= minLiquidity);
            }

            // ‰∫§ÊòìÈáèÁ≠õÈÄâ
            if (minVolume > 0) {
                filtered = filtered.filter(pair => pair.trade_volume_24h >= minVolume);
            }

            // ÊéíÂ∫è
            filtered.sort((a, b) => {
                let valueA, valueB;

                switch (sortBy) {
                    case 'name':
                        valueA = a.name.toLowerCase();
                        valueB = b.name.toLowerCase();
                        break;
                    case 'liquidity':
                        valueA = parseFloat(a.liquidity);
                        valueB = parseFloat(b.liquidity);
                        break;
                    case 'volume':
                        valueA = a.trade_volume_24h;
                        valueB = b.trade_volume_24h;
                        break;
                    case 'fees':
                        valueA = a.fees_24h;
                        valueB = b.fees_24h;
                        break;
                    case 'apr':
                        valueA = a.apr || 0;
                        valueB = b.apr || 0;
                        break;
                    case 'bin_step':
                        valueA = a.bin_step || 0;
                        valueB = b.bin_step || 0;
                        break;
                    case 'base_fee_percentage':
                        valueA = parseFloat(a.base_fee_percentage) || 0;
                        valueB = parseFloat(b.base_fee_percentage) || 0;
                        break;
                    case 'fee_tvl_30min':
                        valueA = (a.fee_tvl_ratio && a.fee_tvl_ratio.min_30) || 0;
                        valueB = (b.fee_tvl_ratio && b.fee_tvl_ratio.min_30) || 0;
                        break;
                    default:
                        valueA = parseFloat(a.liquidity);
                        valueB = parseFloat(b.liquidity);
                }

                if (sortOrder === 'asc') {
                    return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                } else {
                    return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                }
            });

            filteredPairs = filtered;
            currentPage = 1; // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
        };

        // Ëé∑ÂèñÂΩìÂâçÈ°µÁöÑÊï∞ÊçÆ
        const getCurrentPageData = () => {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            return filteredPairs.slice(startIndex, endIndex);
        };

        // Ëé∑ÂèñÊÄªÈ°µÊï∞
        const getTotalPages = () => {
            return Math.ceil(filteredPairs.length / itemsPerPage);
        };

        // Êõ¥Êñ∞Á≠õÈÄâÊù°‰ª∂
        const updateFilters = () => {
            searchTerm = document.getElementById('searchInput').value;
            minLiquidity = parseFloat(document.getElementById('minLiquidity').value) || 0;
            minVolume = parseFloat(document.getElementById('minVolume').value) || 0;
            applyFiltersAndSort();
            render();
        };

        // Êõ¥Êñ∞ÊéíÂ∫è
        const updateSort = (newSortBy) => {
            if (sortBy === newSortBy) {
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                sortBy = newSortBy;
                sortOrder = 'desc';
            }
            applyFiltersAndSort();
            render();
        };

        // Êõ¥ÊîπÈ°µÈù¢
        const changePage = (page) => {
            const totalPages = getTotalPages();
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                render();
            }
        };

        // Êõ¥ÊîπÊØèÈ°µÊòæÁ§∫Êï∞Èáè
        const changeItemsPerPage = (newItemsPerPage) => {
            itemsPerPage = newItemsPerPage;
            currentPage = 1;
            render();
        };

        // Ê∏≤ÊüìÂ±ïÂºÄÁöÑ‰∫§ÊòìÂØπËØ¶ÊÉÖ
        const renderExpandedPair = (pair) => {
            const pairWallets = walletData[pair.address] || [];
            const filter = initWalletFilter(pair.address);
            const filteredWallets = getFilteredAndSortedWallets(pair.address);
            const currentPageWallets = getCurrentPageWallets(pair.address);
            const totalPages = getWalletTotalPages(pair.address);

            return `
                <div class="border-t bg-gray-50 p-6">
                    <h4 class="font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="trending-up" class="w-4 h-4"></i>
                        Wallet PNL Rankings (${pairWallets.length} total, ${filteredWallets.length} filtered)
                    </h4>

                    ${pairWallets.length > 0 ? `
                        <!-- Wallet Filter Controls -->
                        <div class="bg-white rounded-lg p-4 mb-4 border">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Search Wallet</label>
                                    <input
                                        type="text"
                                        id="walletSearch_${pair.address}"
                                        placeholder="Search wallet address..."
                                        value="${filter.searchTerm}"
                                        oninput="updateWalletFilters('${pair.address}')"
                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                    >
                                </div>

                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Min PNL ($)</label>
                                    <input
                                        type="number"
                                        id="minPnl_${pair.address}"
                                        placeholder="0"
                                        value="${filter.minPnl || ''}"
                                        oninput="updateWalletFilters('${pair.address}')"
                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                    >
                                </div>

                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Items per Page</label>
                                    <select
                                        onchange="changeWalletItemsPerPage('${pair.address}', parseInt(this.value))"
                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                    >
                                        <option value="5" ${filter.itemsPerPage === 5 ? 'selected' : ''}>5</option>
                                        <option value="10" ${filter.itemsPerPage === 10 ? 'selected' : ''}>10</option>
                                        <option value="20" ${filter.itemsPerPage === 20 ? 'selected' : ''}>20</option>
                                        <option value="50" ${filter.itemsPerPage === 50 ? 'selected' : ''}>50</option>
                                    </select>
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-2">
                                <button
                                    onclick="updateWalletSort('${pair.address}', 'total_fee_usd_claimed')"
                                    class="px-2 py-1 text-xs rounded ${filter.sortBy === 'total_fee_usd_claimed' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    PNL ${filter.sortBy === 'total_fee_usd_claimed' ? (filter.sortOrder === 'asc' ? '‚Üë' : '‚Üì') : ''}
                                </button>
                                <button
                                    onclick="updateWalletSort('${pair.address}', 'wallet')"
                                    class="px-2 py-1 text-xs rounded ${filter.sortBy === 'wallet' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    Address ${filter.sortBy === 'wallet' ? (filter.sortOrder === 'asc' ? '‚Üë' : '‚Üì') : ''}
                                </button>
                            </div>
                        </div>

                        <!-- Wallet Pagination Info -->
                        ${totalPages > 1 ? `
                            <div class="flex justify-between items-center mb-3 text-xs text-gray-600">
                                <div>
                                    Showing ${(filter.currentPage - 1) * filter.itemsPerPage + 1} - ${Math.min(filter.currentPage * filter.itemsPerPage, filteredWallets.length)} of ${filteredWallets.length} wallets
                                </div>
                                <div class="flex items-center gap-1">
                                    <button
                                        onclick="changeWalletPage('${pair.address}', ${filter.currentPage - 1})"
                                        ${filter.currentPage === 1 ? 'disabled' : ''}
                                        class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Prev
                                    </button>
                                    <span class="px-2 py-1 text-xs bg-blue-500 text-white rounded">
                                        ${filter.currentPage} / ${totalPages}
                                    </span>
                                    <button
                                        onclick="changeWalletPage('${pair.address}', ${filter.currentPage + 1})"
                                        ${filter.currentPage === totalPages ? 'disabled' : ''}
                                        class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Next
                                    </button>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Wallet List -->
                        <div class="space-y-2">
                            ${currentPageWallets.map((wallet, index) => {
                                const globalIndex = (filter.currentPage - 1) * filter.itemsPerPage + index + 1;
                                const key = `${pair.address}_${wallet}`;
                                const pnl = pnlData[key];
                                const isLoading = pnlLoading.has(key);

                                return `
                                    <div class="flex items-center justify-between p-3 bg-white rounded border">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-sm font-semibold">
                                                #${globalIndex}
                                            </div>
                                            <div>
                                                <div class="font-mono text-sm hover:text-blue-600 cursor-pointer"
                                                     onclick="window.open('https://app.lpagent.io/portfolio?address=${wallet}', '_blank')"
                                                     title="View portfolio on LP Agent">
                                                    ${formatAddress(wallet)}
                                                    <i data-lucide="external-link" class="w-3 h-3 inline ml-1"></i>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="flex items-center gap-4">
                                            ${isLoading ? `
                                                <div class="text-gray-500 text-sm flex items-center gap-2">
                                                    <i data-lucide="refresh-cw" class="w-4 h-4 animate-spin"></i>
                                                    Loading...
                                                </div>
                                            ` : pnl?.error ? `
                                                <div class="text-red-500 text-sm">Error loading</div>
                                            ` : pnl ? `
                                                <div class="text-right">
                                                    <div class="font-semibold text-green-600">
                                                        $${pnl.total_fee_usd_claimed?.toFixed(2) || '0.00'}
                                                    </div>
                                                    <div class="text-xs text-gray-500">
                                                        X: ${(parseFloat(pnl.total_fee_x_claimed) / 1e9).toFixed(4)} |
                                                        Y: ${(parseFloat(pnl.total_fee_y_claimed) / 1e9).toFixed(4)}
                                                    </div>
                                                </div>
                                            ` : `
                                                <button
                                                    onclick="fetchWalletPnl('${pair.address}', '${wallet}')"
                                                    class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600"
                                                >
                                                    Load PNL
                                                </button>
                                            `}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div class="text-gray-500 text-center py-8">
                            <div class="mb-2">
                                ${walletDataLoaded ? 'No wallet data available for this LB pair' : 'Wallet data not loaded yet'}
                            </div>
                            ${!walletDataLoaded ? `
                                <div class="text-sm">
                                    <button
                                        onclick="fetchDuneData()"
                                        ${walletDataLoading ? 'disabled' : ''}
                                        class="px-3 py-1 ${walletDataLoading ? 'bg-yellow-500' : 'bg-blue-500 hover:bg-blue-600'} text-white rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        ${walletDataLoading ? 'Loading...' : 'Load Wallet Data'}
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `}
                </div>
            `;
        };

        // Ê∏≤ÊüìÂçï‰∏™‰∫§ÊòìÂØπ
        const renderPair = (pair) => {
            const isExpanded = expandedPairs.has(pair.address);
            const pairWallets = walletData[pair.address] || [];

            return `
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800 hover:text-blue-600 cursor-pointer"
                                        onclick="window.open('https://app.meteora.ag/dlmm/${pair.address}', '_blank')">
                                        ${pair.name}
                                        <i data-lucide="external-link" class="w-4 h-4 inline ml-1"></i>
                                    </h3>
                                    <p class="text-gray-500 text-sm font-mono">${formatAddress(pair.address)}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button
                                    onclick="event.stopPropagation(); ${pairWallets.length ? `fetchAllPnlForPair('${pair.address}')` : `alert('No wallet data for this pair. Please load wallet data first.')`}"
                                    class="px-3 py-1 ${pairWallets.length ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-400 hover:bg-gray-500'} text-white rounded text-sm"
                                >
                                    Get PNL ${pairWallets.length ? `(${pairWallets.length})` : '(0)'}
                                </button>
                                <button
                                    onclick="toggleExpanded('${pair.address}')"
                                    class="p-2 hover:bg-gray-100 rounded"
                                >
                                    <i data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" class="w-5 h-5 text-gray-400"></i>
                                </button>
                            </div>
                        </div>

                        <!-- ËØ¶ÁªÜ‰ø°ÊÅØÁΩëÊ†º -->
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-sm">
                            <div class="bg-blue-50 p-3 rounded">
                                <div class="text-gray-500 text-xs">Liquidity</div>
                                <div class="font-semibold text-blue-600">$${formatNumber(parseFloat(pair.liquidity))}</div>
                            </div>
                            <div class="bg-green-50 p-3 rounded">
                                <div class="text-gray-500 text-xs">24h Volume</div>
                                <div class="font-semibold text-green-600">$${formatNumber(pair.trade_volume_24h)}</div>
                            </div>
                            <div class="bg-yellow-50 p-3 rounded">
                                <div class="text-gray-500 text-xs">24h Fees</div>
                                <div class="font-semibold text-yellow-600">$${formatNumber(pair.fees_24h)}</div>
                            </div>
                            <div class="bg-purple-50 p-3 rounded">
                                <div class="text-gray-500 text-xs">APR</div>
                                <div class="font-semibold text-purple-600">${pair.apr?.toFixed(2) || '0.00'}%</div>
                            </div>
                            <div class="bg-indigo-50 p-3 rounded">
                                <div class="text-gray-500 text-xs">Bin Step</div>
                                <div class="font-semibold text-indigo-600">${pair.bin_step || 'N/A'}</div>
                            </div>
                            <div class="bg-pink-50 p-3 rounded">
                                <div class="text-gray-500 text-xs">Base Fee</div>
                                <div class="font-semibold text-pink-600">${pair.base_fee_percentage ? parseFloat(pair.base_fee_percentage).toFixed(3) + '%' : 'N/A'}</div>
                            </div>
                            <div class="bg-orange-50 p-3 rounded">
                                <div class="text-gray-500 text-xs">30min Fee/TVL</div>
                                <div class="font-semibold text-orange-600">${pair.fee_tvl_ratio?.min_30 ? pair.fee_tvl_ratio.min_30.toFixed(2) + '%' : 'N/A'}</div>
                            </div>
                        </div>
                    </div>

                    ${isExpanded ? renderExpandedPair(pair) : ''}
                </div>
            `;
        };

        // ‰∏ªÊ∏≤ÊüìÂáΩÊï∞
        const render = () => {
            const app = document.getElementById('app');

            const totalWallets = Object.keys(walletData).reduce((sum, key) => sum + walletData[key].length, 0);
            const totalPnlRecords = Object.keys(pnlData).length;
            const currentPageData = getCurrentPageData();
            const totalPages = getTotalPages();

            app.innerHTML = `
                <div class="min-h-screen bg-gray-50 p-6">
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h1 class="text-3xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <i data-lucide="dollar-sign" class="text-green-500"></i>
                                Meteora LB Pair PNL Tracker
                            </h1>

                            <div class="flex gap-4 mb-6">
                                <button
                                    onclick="fetchLbPairs()"
                                    ${loading ? 'disabled' : ''}
                                    class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50"
                                >
                                    <i data-lucide="refresh-cw" class="w-4 h-4 ${loading ? 'animate-spin' : ''}"></i>
                                    Refresh LB Pairs
                                </button>
                                <button
                                    onclick="fetchDuneData()"
                                    ${walletDataLoading ? 'disabled' : ''}
                                    class="flex items-center gap-2 px-4 py-2 ${walletDataLoaded ? 'bg-gray-500' : walletDataLoading ? 'bg-yellow-500' : 'bg-green-500'} text-white rounded-lg ${!walletDataLoading && !walletDataLoaded ? 'hover:bg-green-600' : ''} disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    <i data-lucide="${walletDataLoading ? 'refresh-cw' : walletDataLoaded ? 'check' : 'database'}" class="w-4 h-4 ${walletDataLoading ? 'animate-spin' : ''}"></i>
                                    ${walletDataLoading ? 'Loading...' : walletDataLoaded ? 'Data Loaded' : (DEVELOPMENT_MODE ? 'Load Wallet Data (Smart)' : 'Load Wallet Data')}
                                </button>
                                ${DEVELOPMENT_MODE ? `
                                    <div class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">
                                        <i data-lucide="zap" class="w-3 h-3 inline mr-1"></i>
                                        Smart Mode: Local file ‚Üí Dune API fallback
                                    </div>
                                ` : ''}
                                <button
                                    onclick="console.log('Wallet Data:', walletData); console.log('Total pairs with wallets:', Object.keys(walletData).length);"
                                    class="flex items-center gap-2 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600"
                                >
                                    <i data-lucide="bug" class="w-4 h-4"></i>
                                    Debug Info
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-blue-600">${lbPairs.length}</div>
                                    <div class="text-blue-500">Total LB Pairs</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600">${filteredPairs.length}</div>
                                    <div class="text-green-500">Filtered Pairs</div>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-orange-600">${totalWallets}</div>
                                    <div class="text-orange-500">Total Wallets</div>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-purple-600">${totalPnlRecords}</div>
                                    <div class="text-purple-500">PNL Records</div>
                                </div>
                            </div>
                        </div>

                        <!-- Disclaimer and Contact Info -->
                        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div class="border-l-4 border-yellow-400 bg-yellow-50 p-4 mb-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-yellow-800">Disclaimer</h3>
                                        <div class="mt-2 text-sm text-yellow-700">
                                            <p>This tool is for informational purposes only and does not constitute financial advice.
                                            The data presented here should not be used as the sole basis for investment decisions.
                                            Cryptocurrency and DeFi investments carry significant risks, including the potential loss of principal.
                                            Always conduct your own research and consult with qualified financial advisors before making investment decisions.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="border-t pt-4">
                                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                    <div class="mb-4 sm:mb-0">
                                        <h4 class="text-sm font-medium text-gray-900 mb-2">Contact & Links</h4>
                                        <div class="flex flex-wrap gap-4 text-sm">
                                            <a href="https://x.com/rochestor_mu" target="_blank"
                                               class="flex items-center gap-1 text-blue-600 hover:text-blue-800 transition-colors">
                                                <i data-lucide="twitter" class="w-4 h-4"></i>
                                                X (Twitter)
                                            </a>
                                            <a href="https://github.com/gududefengzhong" target="_blank"
                                               class="flex items-center gap-1 text-gray-700 hover:text-gray-900 transition-colors">
                                                <i data-lucide="github" class="w-4 h-4"></i>
                                                GitHub
                                            </a>
                                            <a href="https://dune.com/rockets" target="_blank"
                                               class="flex items-center gap-1 text-purple-600 hover:text-purple-800 transition-colors">
                                                <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                                                Dune Analytics
                                            </a>
                                            <a href="https://app.lpagent.io/?referral=GE6Csiu" target="_blank"
                                               class="flex items-center gap-1 text-green-600 hover:text-green-800 transition-colors">
                                                <i data-lucide="trending-up" class="w-4 h-4"></i>
                                                LP Agent
                                            </a>
                                        </div>
                                    </div>

                                    <div class="text-right text-sm text-gray-500">
                                        <div>Built with ‚ù§Ô∏è for the Lp Army community</div>
                                        <div class="mt-1">¬© 2025 Meteora LB Pair Tracker</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filter and Sort Controls -->
                        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i data-lucide="filter" class="w-5 h-5"></i>
                                Filter and Sort
                            </h2>

                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                                    <input
                                        type="text"
                                        id="searchInput"
                                        placeholder="Search pair name or address..."
                                        value="${searchTerm}"
                                        oninput="updateFilters()"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Min Liquidity ($)</label>
                                    <input
                                        type="number"
                                        id="minLiquidity"
                                        placeholder="0"
                                        value="${minLiquidity || ''}"
                                        oninput="updateFilters()"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Min 24h Volume ($)</label>
                                    <input
                                        type="number"
                                        id="minVolume"
                                        placeholder="0"
                                        value="${minVolume || ''}"
                                        oninput="updateFilters()"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Items per Page</label>
                                    <select
                                        onchange="changeItemsPerPage(parseInt(this.value))"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>10</option>
                                        <option value="25" ${itemsPerPage === 25 ? 'selected' : ''}>25</option>
                                        <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50</option>
                                        <option value="100" ${itemsPerPage === 100 ? 'selected' : ''}>100</option>
                                    </select>
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-2">
                                <button
                                    onclick="updateSort('name')"
                                    class="px-3 py-1 text-sm rounded-md ${sortBy === 'name' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    Name ${sortBy === 'name' ? (sortOrder === 'asc' ? '‚Üë' : '‚Üì') : ''}
                                </button>
                                <button
                                    onclick="updateSort('liquidity')"
                                    class="px-3 py-1 text-sm rounded-md ${sortBy === 'liquidity' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    Liquidity ${sortBy === 'liquidity' ? (sortOrder === 'asc' ? '‚Üë' : '‚Üì') : ''}
                                </button>
                                <button
                                    onclick="updateSort('volume')"
                                    class="px-3 py-1 text-sm rounded-md ${sortBy === 'volume' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    24h Volume ${sortBy === 'volume' ? (sortOrder === 'asc' ? '‚Üë' : '‚Üì') : ''}
                                </button>
                                <button
                                    onclick="updateSort('fees')"
                                    class="px-3 py-1 text-sm rounded-md ${sortBy === 'fees' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    24h Fees ${sortBy === 'fees' ? (sortOrder === 'asc' ? '‚Üë' : '‚Üì') : ''}
                                </button>
                                <button
                                    onclick="updateSort('apr')"
                                    class="px-3 py-1 text-sm rounded-md ${sortBy === 'apr' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    APR ${sortBy === 'apr' ? (sortOrder === 'asc' ? '‚Üë' : '‚Üì') : ''}
                                </button>
                                <button
                                    onclick="updateSort('bin_step')"
                                    class="px-3 py-1 text-sm rounded-md ${sortBy === 'bin_step' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    Bin Step ${sortBy === 'bin_step' ? (sortOrder === 'asc' ? '‚Üë' : '‚Üì') : ''}
                                </button>
                                <button
                                    onclick="updateSort('base_fee_percentage')"
                                    class="px-3 py-1 text-sm rounded-md ${sortBy === 'base_fee_percentage' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    Base Fee ${sortBy === 'base_fee_percentage' ? (sortOrder === 'asc' ? '‚Üë' : '‚Üì') : ''}
                                </button>
                                <button
                                    onclick="updateSort('fee_tvl_30min')"
                                    class="px-3 py-1 text-sm rounded-md ${sortBy === 'fee_tvl_30min' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-600 hover:text-white"
                                >
                                    30min Fee/TVL ${sortBy === 'fee_tvl_30min' ? (sortOrder === 'asc' ? '‚Üë' : '‚Üì') : ''}
                                </button>
                            </div>
                        </div>

                        ${loading ? `
                            <div class="flex justify-center items-center py-12">
                                <i data-lucide="refresh-cw" class="w-8 h-8 animate-spin text-blue-500"></i>
                                <span class="ml-2 text-gray-600">Loading LB Pairs...</span>
                            </div>
                        ` : `
                            <!-- Pagination Info -->
                            <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
                                <div class="flex justify-between items-center">
                                    <div class="text-sm text-gray-600">
                                        Showing ${(currentPage - 1) * itemsPerPage + 1} - ${Math.min(currentPage * itemsPerPage, filteredPairs.length)} of ${filteredPairs.length} records
                                    </div>

                                    <div class="flex items-center gap-2">
                                        <button
                                            onclick="changePage(1)"
                                            ${currentPage === 1 ? 'disabled' : ''}
                                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            First
                                        </button>
                                        <button
                                            onclick="changePage(${currentPage - 1})"
                                            ${currentPage === 1 ? 'disabled' : ''}
                                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            Previous
                                        </button>

                                        <span class="px-3 py-1 text-sm bg-blue-500 text-white rounded">
                                            ${currentPage} / ${totalPages}
                                        </span>

                                        <button
                                            onclick="changePage(${currentPage + 1})"
                                            ${currentPage === totalPages ? 'disabled' : ''}
                                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            Next
                                        </button>
                                        <button
                                            onclick="changePage(${totalPages})"
                                            ${currentPage === totalPages ? 'disabled' : ''}
                                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            Last
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- ‰∫§ÊòìÂØπÂàóË°® -->
                            <div class="space-y-4">
                                ${currentPageData.map(pair => renderPair(pair)).join('')}
                            </div>

                            <!-- Bottom Pagination -->
                            <div class="bg-white rounded-lg shadow-lg p-4 mt-6">
                                <div class="flex justify-center items-center gap-2">
                                    <button
                                        onclick="changePage(1)"
                                        ${currentPage === 1 ? 'disabled' : ''}
                                        class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        First
                                    </button>
                                    <button
                                        onclick="changePage(${currentPage - 1})"
                                        ${currentPage === 1 ? 'disabled' : ''}
                                        class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Previous
                                    </button>

                                    ${Array.from({length: Math.min(5, totalPages)}, (_, i) => {
                                        let pageNum;
                                        if (totalPages <= 5) {
                                            pageNum = i + 1;
                                        } else if (currentPage <= 3) {
                                            pageNum = i + 1;
                                        } else if (currentPage >= totalPages - 2) {
                                            pageNum = totalPages - 4 + i;
                                        } else {
                                            pageNum = currentPage - 2 + i;
                                        }

                                        return `
                                            <button
                                                onclick="changePage(${pageNum})"
                                                class="px-3 py-1 text-sm rounded ${pageNum === currentPage ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                                            >
                                                ${pageNum}
                                            </button>
                                        `;
                                    }).join('')}

                                    <button
                                        onclick="changePage(${currentPage + 1})"
                                        ${currentPage === totalPages ? 'disabled' : ''}
                                        class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Next
                                    </button>
                                    <button
                                        onclick="changePage(${totalPages})"
                                        ${currentPage === totalPages ? 'disabled' : ''}
                                        class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Last
                                    </button>
                                </div>
                            </div>


                        `}
                    </div>
                </div>
            `;

            // ÈáçÊñ∞ÂàùÂßãÂåñ Lucide ÂõæÊ†á
            lucide.createIcons();
        };

        // ÂàùÂßãÂåñÂ∫îÁî®
        document.addEventListener('DOMContentLoaded', () => {
            // ÂàùÂßãÂåñÁ≠õÈÄâÊï∞ÊçÆ
            filteredPairs = [...lbPairs];
            render();
            fetchLbPairs();
            fetchDuneData();
        });
    </script>
</body>
</html>
